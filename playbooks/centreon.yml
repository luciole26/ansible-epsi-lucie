- name: Installation de Centreon sur Debian 11/12
  hosts: STG_HAPROXY
  gather_facts: true
  become: true

  tasks:
    - name: Update & Upgrade
      apt:
        update_cache: true
        upgrade: yes

    - name: Packages
      apt:
        name: 
        - lsb-release 
        - ca-certificates 
        - apt-transport-https 
        - software-properties-common 
        - wget 
        - gnupg2 
        - curl
        state: present

    - name: Install repository
      template:
        src: sury-php.list.j2
        dest: /etc/apt/sources.list.d/sury-php.list
    
    - name: Import sury repository key
      apt_key: 
        url: https://packages.sury.org/php/apt.gpg
        state: present


    - name: Download mariadb 10.11 script
      ansible.builtin.get_url:
        url: https://r.mariadb.com/downloads/mariadb_repo_setup
        dest: /tmp/mariadb.sh
        mode: "+x"
      
    - name: Execute mariadb script
      command: bash /tmp/mariadb.sh -s -- --os-type=debian --os-version=11 --mariadb-server-version="mariadb-10.11"


    - name: Install centreon
      template:
        src: centreon.list.j2
        dest: /etc/apt/sources.list.d/centreon.list

    - name: Install centreon plugins
      template:
        src: centreon-plugins.list.j2
        dest: /etc/apt/sources.list.d/centreon-plugins.list

    - name: Import centreon repository key
      apt_key: 
        url: https://apt-key.centreon.com
        state: present
    
    
    - name: Update after adding repo & keys
      apt:
        update_cache: true
